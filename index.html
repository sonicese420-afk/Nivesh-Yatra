<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NY Test ‚Äî fixed detail overlay & chart</title>
<style>
  :root{--bg1:#041212;--bg2:#071b1b;--accent:#2fd59f;--muted:#9fb6b3;--text:#eaf6f3;--radius:14px}
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Roboto,Arial;color:var(--text);background:linear-gradient(180deg,var(--bg1),var(--bg2))}
  .app-header{display:flex;gap:12px;align-items:center;padding:14px;background:linear-gradient(90deg,#2d8e7f,#2b8e7e);position:sticky;top:0;z-index:50}
  .logo-btn{display:inline-flex;align-items:center;justify-content:center;border-radius:12px;background:rgba(255,255,255,.04);padding:6px}
  .brand{display:flex;flex-direction:column}
  .brand .title{font-weight:800;font-size:18px}
  .brand .subtitle{font-size:12px;color:rgba(255,255,255,.9)}
  .header-actions{margin-left:auto;display:flex;gap:8px}
  .icon-btn{background:rgba(255,255,255,.04);border-radius:10px;padding:8px}
  .app-container{padding:18px;padding-bottom:120px;max-width:980px;margin:0 auto}
  .assets-card{display:flex;justify-content:space-between;align-items:center;background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(0,0,0,.12));padding:14px;border-radius:var(--radius);margin-bottom:18px}
  .assets-label{font-size:12px;color:var(--muted);font-weight:700}
  .assets-value{font-size:28px;font-weight:900;margin-top:4px}
  .assets-holdings{color:var(--muted);margin-top:6px}
  .assets-change{background:rgba(47,213,159,.12);padding:10px 14px;border-radius:20px;color:var(--accent);font-weight:800}
  .tabs{display:flex;gap:10px;margin-bottom:10px}
  .tab{cursor:pointer;background:rgba(255,255,255,.01);color:var(--muted);padding:8px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.02);font-weight:700}
  .tab.active{color:var(--text);background:rgba(255,255,255,.03)}
  .section-title{font-size:28px;margin:6px 0 12px;font-weight:900}
  .list{display:flex;flex-direction:column;gap:12px;min-height:80px}
  .item{display:flex;justify-content:space-between;gap:12px;padding:12px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,.01),rgba(0,0,0,.08));align-items:center}
  .left{display:flex;gap:12px;align-items:center}
  .avatar{width:52px;height:52px;border-radius:12px;background:rgba(255,255,255,.03);display:flex;align-items:center;justify-content:center;font-weight:800;color:var(--muted);font-size:15px}
  .meta{display:flex;flex-direction:column}
  .meta .name{font-weight:800;font-size:16px}
  .meta .sub{font-size:12px;color:var(--muted);margin-top:6px;text-transform:uppercase;letter-spacing:.02em}
  .price{font-weight:900;text-align:right;min-width:110px}
  .bottom-pill{position:fixed;left:50%;transform:translateX(-50%);bottom:86px;background:rgba(0,0,0,.6);padding:14px 18px;border-radius:34px;display:flex;gap:18px;z-index:40}
  .pill-btn{background:transparent;border:none;color:var(--muted);padding:8px 12px;border-radius:18px;font-weight:800;cursor:pointer}
  .pill-btn.active{background:rgba(255,255,255,.04);color:var(--text)}
  /* ------ DETAIL OVERLAY fixed & robust layout ------ */
  .detail-overlay{position:fixed;inset:0;z-index:120;display:none;flex-direction:column;align-items:stretch;background:rgba(3,3,3,0.96);padding:12px 12px 24px;overflow:auto}
  .detail-overlay.open{display:flex}
  .detail-close{position:absolute;right:16px;top:16px;background:rgba(255,255,255,.06);border:none;padding:8px;border-radius:10px;color:var(--text);cursor:pointer;z-index:130}
  .detail-header{display:flex;justify-content:space-between;align-items:center;margin-top:8px;margin-bottom:8px;z-index:129}
  .detail-left{display:flex;gap:12px;align-items:center}
  .detail-avatar{width:56px;height:56px;border-radius:12px;background:rgba(255,255,255,.03);display:flex;align-items:center;justify-content:center;font-weight:900;color:var(--text)}
  .detail-name{font-size:18px;font-weight:800}
  .detail-sub{font-size:12px;color:var(--muted);text-transform:uppercase}
  /* wrapper to keep chart visible and never let it expand off screen */
  .detail-main{display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap}
  .detail-chart-wrap{flex:1;min-width:260px;max-width:100%;background:linear-gradient(180deg,rgba(255,255,255,.01),rgba(0,0,0,.04));border-radius:14px;padding:10px;position:relative;box-shadow:0 10px 30px rgba(0,0,0,.6)}
  .detail-chart{width:100%;height:320px;border-radius:8px;background:transparent;display:block}
  /* chart controls (stacked on right of chart) */
  .chart-controls{position:absolute;right:12px;top:12px;display:flex;flex-direction:column;gap:8px;z-index:12}
  .chart-btn{background:rgba(255,255,255,.95);border:none;padding:6px 8px;border-radius:6px;cursor:pointer;font-weight:700}
  .chart-btn.active{background:#fff}
  .detail-rightside{min-width:120px;display:flex;flex-direction:column;gap:8px;align-items:flex-end}
  .detail-price{font-weight:900;font-size:20px}
  .detail-change-badge{font-weight:800;padding:6px 10px;border-radius:10px}
  .detail-actions{display:flex;align-items:center;gap:12px;margin-top:12px}
  .qty-input{width:88px;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,.04);background:transparent;color:var(--text)}
  .action-buy{background:var(--accent);border:none;padding:10px 14px;border-radius:10px;color:#052224;font-weight:900;cursor:pointer}
  .action-sell{background:#ff5b5b;border:none;padding:10px 14px;border-radius:10px;color:white;font-weight:900;cursor:pointer}
  .action-sip{background:rgba(47,213,159,.08);border:1px solid rgba(47,213,159,.12);padding:10px 14px;border-radius:10px;color:var(--accent);font-weight:900;cursor:pointer}
  .detail-tabs{display:flex;gap:12px;margin-top:18px}
  .detail-tab{background:transparent;border:none;color:var(--muted);padding:8px 10px;border-radius:8px;cursor:pointer}
  .detail-tab.active{color:var(--text);border-bottom:2px solid var(--accent)}
  .empty{padding:18px;color:var(--muted)}
  @media(min-width:900px){ .detail-main { flex-wrap:nowrap } .detail-chart{height:420px} }
</style>
</head>
<body>
  <header class="app-header">
    <button class="logo-btn" aria-label="logo">
      <svg width="56" height="56" viewBox="0 0 100 100"><rect width="100" height="100" rx="16" fill="#2c9686"></rect><g transform="translate(14,14)" fill="white"><path d="M20 46 L40 20 L48 28 L28 58 Z" opacity="0.95"></path></g></svg>
    </button>
    <div class="brand">
      <div class="title">Nivesh Yatra</div>
      <div class="subtitle">Turning dreams into Assets.</div>
    </div>
    <div class="header-actions" style="margin-left:auto">
      <button class="icon-btn" id="toggleEye">üëÅÔ∏è</button>
      <button class="icon-btn" id="bell">üîî</button>
    </div>
  </header>

  <main class="app-container">
    <section class="assets-card">
      <div>
        <div class="assets-label">MY ASSETS</div>
        <div id="assetsValue" class="assets-value">‚Çπ0</div>
        <div id="assetsHoldings" class="assets-holdings">Holdings: 0</div>
      </div>
      <div>
        <div id="assetsChange" class="assets-change">+‚Çπ0 (0.00%)</div>
      </div>
    </section>

    <nav class="tabs" role="tablist">
      <button class="tab active" data-tab="stocks">Stocks</button>
      <button class="tab" data-tab="funds">Funds</button>
      <button class="tab" data-tab="portfolio">Portfolio</button>
    </nav>

    <section id="stocksSection"><h2 class="section-title">Buy Stocks</h2><div id="stocksList" class="list"></div></section>
    <section id="fundsSection" hidden><h2 class="section-title">Mutual Funds</h2><div id="fundsList" class="list"></div></section>
    <section id="portfolioSection" hidden><h2 class="section-title">Your Portfolio</h2><div id="portfolioList" class="list"></div></section>
  </main>

  <div class="bottom-pill">
    <button class="pill-btn active" data-tab="stocks">üìà Stocks</button>
    <button class="pill-btn" data-tab="funds">üìä Funds</button>
    <button class="pill-btn" data-tab="portfolio">üìÅ Portfolio</button>
  </div>

  <!-- DETAIL OVERLAY -->
  <div id="detailOverlay" class="detail-overlay" aria-hidden="true">
    <button id="closeDetail" class="detail-close" aria-label="Close">‚úï</button>
    <div class="detail-header">
      <div class="detail-left">
        <div id="detailAvatar" class="detail-avatar">RE</div>
        <div>
          <div id="detailName" class="detail-name">Reliance Industries Ltd</div>
          <div id="detailSub" class="detail-sub">Stock | RELIANCE</div>
        </div>
      </div>
      <div class="detail-rightside">
        <div id="detailPrice" class="detail-price">‚Çπ0</div>
        <div id="detailChangeBadge" class="detail-change-badge" hidden>‚ñ≤ 0.00%</div>
      </div>
    </div>

    <div class="detail-main">
      <div class="detail-chart-wrap">
        <canvas id="detailChart" class="detail-chart"></canvas>
        <div class="chart-controls" role="toolbar" aria-label="Chart controls">
          <button class="chart-btn active" data-range="1d">1D</button>
          <button class="chart-btn" data-range="1w">1W</button>
          <button class="chart-btn" data-range="1m">1M</button>
          <button class="chart-btn" data-range="6m">6M</button>
          <button class="chart-btn" data-range="1y">1Y</button>
        </div>
      </div>

      <div style="min-width:140px;display:flex;flex-direction:column;gap:12px">
        <div style="font-weight:800">Actions</div>
        <div class="detail-actions">
          <label for="qtyInput" style="font-weight:700">Qty</label>
          <input id="qtyInput" class="qty-input" type="number" min="1" value="1" />
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="sellBtn" class="action-sell">SELL</button>
          <button id="buyBtn" class="action-buy">BUY</button>
          <button id="sipBtn" class="action-sip">SIP</button>
        </div>
        <div class="detail-tabs" style="margin-top:16px">
          <button class="detail-tab active">Details</button>
          <button class="detail-tab">Orders</button>
          <button class="detail-tab">News</button>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  'use strict';
  /* ---------- data (mock) ---------- */
  const STOCKS = [
    { id:'RELI', ticker:'RELIANCE', short:'RE', name:'Reliance Industries Ltd', price:1398.07 },
    { id:'TATM', ticker:'TATAMOTORS', short:'TM', name:'Tata Motors', price:1006.98 },
    { id:'ADGN', ticker:'ADANIGREEN', short:'AG', name:'Adani Green', price:1181.45 },
    { id:'WIPR', ticker:'WIPRO', short:'W', name:'Wipro', price:1485.01 },
    { id:'MRF', ticker:'MRF', short:'M', name:'MRF', price:1898.78 },
    { id:'HDFC', ticker:'HDFC', short:'H', name:'HDFC', price:1846.28 },
    { id:'AFFL', ticker:'AFFLE', short:'AF', name:'Affle 3i Ltd', price:410.22 }
  ];
  const FUNDS = [
    { id:'EDEL', code:'EDEL', name:'Edelweiss Nifty Midcap150 Momentum 50 Index Fund', price:232.4 },
    { id:'HDFM', code:'HDFCMID', name:'HDFC Mid Cap Fund', price:132.76 },
    { id:'HDFSC', code:'HDFCSM', name:'HDFC Small Cap Fund', price:276.12 },
    { id:'NIPL', code:'NIPPL', name:'Nippon India Large Cap Fund', price:219.33 },
    { id:'SBIL', code:'SBIL', name:'SBI Large Cap Fund', price:189.44 },
    { id:'NIPM', code:'NIPPM', name:'Nippon India Mid Cap Fund', price:160.55 },
    { id:'NIPS', code:'NIPPS', name:'Nippon India Small Cap Fund', price:102.97 },
    { id:'HDFLC', code:'HDFLC', name:'HDFC Large Cap Fund', price:321.21 }
  ];

  const STORAGE_KEY = 'ny_holdings_v1';
  function loadHoldings(){ try{ const raw = localStorage.getItem(STORAGE_KEY); return raw?JSON.parse(raw):{stocks:{},funds:{}} }catch(e){return {stocks:{},funds:{}}}}
  function saveHoldings(h){ try{ localStorage.setItem(STORAGE_KEY,JSON.stringify(h)); }catch(e){console.error(e)}}
  let holdings = loadHoldings();

  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  function formatINR(n){ return '‚Çπ'+(Number(n)||0).toLocaleString('en-IN',{minimumFractionDigits:2,maximumFractionDigits:2}); }

  /* ---------- renderers ---------- */
  function renderStocks(){
    const root = $('#stocksList'); root.innerHTML='';
    STOCKS.forEach(s=>{
      const el = document.createElement('div'); el.className='item';
      const owned = holdings.stocks[s.short];
      const ownedHtml = owned?`<div style="margin-top:8px;color:var(--muted);font-weight:700">Qty: ${owned.qty} @ ${formatINR(owned.avg)}</div>`:'';
      el.innerHTML = `<div class="left"><div class="avatar">${s.short}</div><div class="meta"><div class="name">${s.name}</div><div class="sub">Stock | ${s.ticker}</div>${ownedHtml}</div></div><div class="price">${formatINR(s.price)}</div>`;
      el.addEventListener('click', ()=>openDetail('stock', s.id));
      root.appendChild(el);
    });
  }
  function renderFunds(){
    const root = $('#fundsList'); root.innerHTML='';
    FUNDS.forEach(f=>{
      const el=document.createElement('div'); el.className='item';
      const owned = holdings.funds[f.code];
      const ownedHtml = owned?`<div style="margin-top:8px;color:var(--muted);font-weight:700">Units: ${owned.units} @ ${formatINR(owned.avg)}</div>`:'';
      el.innerHTML = `<div class="left"><div class="avatar">${f.code.substring(0,2)}</div><div class="meta"><div class="name">${f.name}</div><div class="sub">Fund | ${f.code}</div>${ownedHtml}</div></div><div class="price">${formatINR(f.price)}</div>`;
      el.addEventListener('click', ()=>openDetail('fund', f.id));
      root.appendChild(el);
    });
  }
  function renderPortfolio(){
    const root = $('#portfolioList'); root.innerHTML='';
    const sKeys = Object.keys(holdings.stocks||{}), fKeys=Object.keys(holdings.funds||{});
    if(sKeys.length===0 && fKeys.length===0){ root.innerHTML='<div class="empty">You own nothing yet. Buy stocks or funds to see them here.</div>'; return; }
    sKeys.forEach(sym=>{
      const h=holdings.stocks[sym]; const s=STOCKS.find(x=>x.short===sym); if(!s) return;
      const pl = ((s.price - h.avg)/h.avg)*100; const arrow = pl>=0?'‚ñ≤':'‚ñº';
      const col = pl>=0?'var(--accent)':'#ff5b5b';
      const el=document.createElement('div'); el.className='item';
      el.innerHTML = `<div class="left"><div class="avatar">${s.short}</div><div class="meta"><div class="name">${s.name}</div><div class="sub">Stock | ${s.ticker}</div><div style="margin-top:8px;color:var(--muted);font-weight:700">Qty: ${h.qty} @ ${formatINR(h.avg)}</div></div></div><div style="text-align:right"><div class="price">${formatINR(s.price)}</div><div style="margin-top:8px;color:${col};font-weight:800">${arrow} ${Math.abs(pl).toFixed(2)}%</div></div>`;
      el.addEventListener('click', ()=>openDetail('stock', s.id));
      root.appendChild(el);
    });
    fKeys.forEach(code=>{
      const h=holdings.funds[code]; const f=FUNDS.find(x=>x.code===code); if(!f) return;
      const el=document.createElement('div'); el.className='item';
      el.innerHTML = `<div class="left"><div class="avatar">${f.code.substring(0,2)}</div><div class="meta"><div class="name">${f.name}</div><div class="sub">Fund | ${f.code}</div><div style="margin-top:8px;color:var(--muted);font-weight:700">Units: ${h.units} @ ${formatINR(h.avg)}</div></div></div><div class="price">${formatINR(f.price)}</div>`;
      el.addEventListener('click', ()=>openDetail('fund', f.id));
      root.appendChild(el);
    });
  }

  function updateAssets(){
    let total=0, holdingsCount=0;
    Object.keys(holdings.stocks||{}).forEach(sym=>{ const h=holdings.stocks[sym]; const s=STOCKS.find(x=>x.short===sym); if(!s) return; total+=s.price*h.qty; holdingsCount+=h.qty; });
    Object.keys(holdings.funds||{}).forEach(code=>{ const h=holdings.funds[code]; const f=FUNDS.find(x=>x.code===code); if(!f) return; total+=f.price*h.units; holdingsCount+=h.units; });
    $('#assetsValue').textContent = formatINR(total);
    $('#assetsHoldings').textContent = 'Holdings: '+holdingsCount;
    const change = ((Math.random()-0.5)*100).toFixed(2);
    const pct = total>0?((change/total)*100).toFixed(2):'0.00';
    $('#assetsChange').textContent = (change>=0?'+':'') + formatINR(change) + ' (' + (change>=0?'+':'') + pct + '%)';
  }

  function setTab(tab){
    $$('.tab').forEach(b=>b.classList.toggle('active', b.dataset.tab===tab));
    $$('.pill-btn').forEach(b=>b.classList.toggle('active', b.dataset.tab===tab));
    $('#stocksSection').hidden = tab!=='stocks';
    $('#fundsSection').hidden = tab!=='funds';
    $('#portfolioSection').hidden = tab!=='portfolio';
  }
  $$('.tab').forEach(b=>b.addEventListener('click', ()=>setTab(b.dataset.tab)));
  $$('.pill-btn').forEach(b=>b.addEventListener('click', ()=>setTab(b.dataset.tab)));

  /* ---------- detail overlay + DPR-safe chart ---------- */
  const detailOverlay = $('#detailOverlay'), detailChart = $('#detailChart');
  let detailState = { type:null, id:null, cache:{} };

  function fitCanvas(canvas){
    // ensure canvas matches container's layout pixels and devicePixelRatio
    const rect = canvas.getBoundingClientRect();
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    const width = Math.round(rect.width * dpr);
    const height = Math.round(rect.height * dpr);
    if(canvas.width !== width || canvas.height !== height){
      canvas.width = width;
      canvas.height = height;
      canvas.style.width = rect.width + 'px';
      canvas.style.height = rect.height + 'px';
    }
  }
  function clearCanvas(c){ const ctx=c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height); }
  function drawGrid(ctx,w,h,lines=6){
    ctx.save(); ctx.strokeStyle='rgba(255,255,255,0.03)'; ctx.lineWidth=1;
    for(let i=0;i<=lines;i++){ const y = (h/lines)*i + 0.5; ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke(); }
    ctx.restore();
  }
  function drawSmooth(ctx,pts,w,h,color='rgba(47,213,159,1)'){
    if(pts.length<2) return;
    ctx.save(); ctx.lineCap='round'; ctx.lineJoin='round';
    ctx.lineWidth = Math.max(2, Math.round(Math.min(w,h)*0.008));
    ctx.strokeStyle = color; ctx.beginPath();
    ctx.moveTo(pts[0].x, pts[0].y);
    for(let i=1;i<pts.length-1;i++){
      const xc=(pts[i].x+pts[i+1].x)/2, yc=(pts[i].y+pts[i+1].y)/2;
      ctx.quadraticCurveTo(pts[i].x, pts[i].y, xc, yc);
    }
    ctx.lineTo(pts[pts.length-1].x, pts[pts.length-1].y);
    ctx.stroke(); ctx.restore();
  }
  function seriesToPoints(series,w,h,pad=28){
    const max=Math.max(...series), min=Math.min(...series), span=max-min || 1;
    const innerW = w - pad*2, innerH = h - pad*2;
    return series.map((v,i)=>({ x: pad + (i/(series.length-1))*innerW, y: pad + innerH - ((v-min)/span)*innerH, v }));
  }
  function genSeries(base,n=150,vol=0.03){
    const arr=[]; let p=base*(1+(Math.random()-0.5)*0.01);
    for(let i=0;i<n;i++){ const change=(Math.random()-0.5)*vol*base; p = Math.max(1, p+change); arr.push(parseFloat(p.toFixed(2))); }
    return arr;
  }

  function drawDetail(range='1d'){
    // choose base from item
    let base = 100;
    if(detailState.type==='stock'){ const s = STOCKS.find(x=>x.id===detailState.id); if(s) base = s.price; }
    else if(detailState.type==='fund'){ const f = FUNDS.find(x=>x.id===detailState.id); if(f) base = f.price; }
    // pick length based on range - longer for longer ranges
    let points = (range==='1d'?150: range==='1w'?240: range==='1m'?360: range==='6m'?480:600);
    const cacheKey = detailState.type + ':' + detailState.id + ':' + range;
    if(!detailState.cache[cacheKey]) detailState.cache[cacheKey] = genSeries(base, points, range==='1d'?0.02:0.06);
    const series = detailState.cache[cacheKey];

    // fit canvas then draw
    fitCanvas(detailChart);
    const ctx = detailChart.getContext('2d'); clearCanvas(detailChart);
    const w = detailChart.width, h = detailChart.height;
    // dark background area for chart:
    ctx.fillStyle = 'rgba(2,9,11,0.0)'; ctx.fillRect(0,0,w,h);
    dr
